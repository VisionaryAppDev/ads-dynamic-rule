name: Toggle AdGuard Rules

on:
  schedule:
    # 06:xx Phnom Penh (UTC+7) = 23:00 UTC
    - cron: "20,30,40,50 23 * * *"

    # 22:xx Phnom Penh (UTC+7) = 15:00 UTC
    - cron: "10,20,30,40,50 15 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  toggle:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Toggle rules based on time
        run: |
          FILE="rules.txt"
          HOUR=$(date -u +"%H")
          MIN=$(date -u +"%M")

          echo "UTC time: $HOUR:$MIN"

          # Time range between 06:20 and 22:19 UTC
          if [ "$HOUR" -ge 6 ] && [ "$HOUR" -lt 22 ] || ([ "$HOUR" -eq 22 ] && [ "$MIN" -lt 10 ]); then
            echo "Allowing sites (morning mode)"
            sed -i 's/^!*\(@@\)\{0,1\}||kisskh\.\^/@@||kisskh.^/' "$FILE"
            sed -i 's/^!*\(@@\)\{0,1\}||sub\.streamsub\.\^/@@||sub.streamsub.^/' "$FILE"


          # Time range between 22:10 and 06:19 UTC
          else
            echo "Blocking sites (night mode)"
            sed -i 's/^!*\(@@\)\{0,1\}||kisskh\.\^/!||kisskh.^/' "$FILE"
            sed -i 's/^!*\(@@\)\{0,1\}||sub\.streamsub\.\^/!||sub.streamsub.^/' "$FILE"
          fi

      - name: Commit changes if needed
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add rules.txt
          git diff --cached --quiet || git commit -m "Auto toggle streaming block"
          git push